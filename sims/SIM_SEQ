#!/usr/bin/env bash

# --- Configuration ---
#RRTX_BINARY="./test_kinodynamic_rrtx_R2T"
#FMTX_BINARY="./test_kinodynamic_fmtx_R2T"
RRTX_BINARY="./test_kinodynamic_rrtx_dubin_4D"
FMTX_BINARY="./test_kinodynamic_fmtx_dubin_4D"
#RRTX_BINARY="./test_kinodynamic_rrtx_thruster_5D"
#FMTX_BINARY="./test_kinodynamic_fmtx_thruster_5D"
RUNS=30
BASE_SEED=42
DURATION=20
SAMPLE_COUNTS=(1000)
FACTORS=(2.0)
ISOLATED_CPUS="6,7"  # CPU cores to run the tests on

# Trap to clean up if the script is interrupted (e.g., with Ctrl+C)
trap "echo -e '\nInterrupted. Exiting...'; exit 1" SIGINT

# --- Main Loop ---
for FACTOR in "${FACTORS[@]}"; do
  echo "###############################################################"
  echo "Using FACTOR = ${FACTOR}"
  echo "###############################################################"

  for SAMPLES in "${SAMPLE_COUNTS[@]}"; do
    echo "================================================================"
    echo "Running ${RUNS} trials with --samples ${SAMPLES}"
    echo "================================================================"

    for (( i=0; i<RUNS; i++ )); do
      SEED=$((BASE_SEED + i))
      echo "--- Trial $((i+1))/${RUNS} (seed=${SEED}) ---"

      # --- Step 1: Run RRT* to generate the sample file ---
      echo "--> Running RRTX to generate samples..."
      taskset -c "$ISOLATED_CPUS" \
        "${RRTX_BINARY}" \
          --samples  "${SAMPLES}" \
          --factor   "${FACTOR}" \
          --seed     "${SEED}" \
          --duration "${DURATION}" &
      
      PLANNER_PID=$!
      sleep 0.1  # Brief delay to allow the process to start
      echo "RRTX process ${PLANNER_PID} running on: $(taskset -cp $PLANNER_PID | awk '{print $NF}')"
      wait $PLANNER_PID
      echo "--> RRTX run finished. Sample file 'rrtx_tree_nodes.csv' created."
      
      # --- Step 2: Run FMT* using the samples from RRT* ---
      echo "--> Running FMTX with pre-generated samples..."
      taskset -c "$ISOLATED_CPUS" \
        "${FMTX_BINARY}" \
          --samples  "${SAMPLES}" \
          --factor   "${FACTOR}" \
          --seed     "${SEED}" \
          --duration "${DURATION}" &

      PLANNER_PID=$!
      sleep 0.1 # Brief delay for process start
      echo "FMTX process ${PLANNER_PID} running on: $(taskset -cp $PLANNER_PID | awk '{print $NF}')"
      wait $PLANNER_PID
      echo "--> FMTX run finished."
      
    done
  done
done

echo "âœ… All runs complete."
